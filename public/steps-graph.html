<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fred's Steps Graph</title>
    <script src="chart.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1 data-translate="Fred's Steps Graph">Fred's Steps Graph</h1>
        <nav>
            <a href="/" data-translate="Enter Data">Enter Data</a>
            <a href="/enter-data-tabular.html" data-translate="Enter Data - Tabular">Enter Data - Tabular</a>
            <a href="/history.html" data-translate="View History">View History</a>
            <a href="/steps-graph.html" data-translate="View Steps Graph">View Steps Graph</a>
            <a href="/calendar-view.html" data-translate="Calendar View">Calendar View</a>
            <a href="/exercise-videos.html" data-translate="Exercise Videos">Exercise Videos</a>
            <a href="/help.html" data-translate="Help">Help</a>
            <button id="lang-toggle"><img src="https://flagsapi.com/FR/flat/24.png" alt="French Flag"></button>
        </nav>
    </header>
...
    <script src="translations.js"></script>
    <script>
        let chart;
        let chartData; // Declare chartData globally

        const filterTypeSelect = document.getElementById('filter-type');
        const customDatePickers = document.getElementById('custom-date-pickers');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const langToggleButton = document.getElementById('lang-toggle');
        let currentLang = localStorage.getItem('language') || 'en';

        function setLanguage(lang) {
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'BUTTON' && element.id !== 'lang-toggle') {
                        element.textContent = translations[lang][key];
                    } else if (element.tagName === 'INPUT') {
                        element.title = translations[lang][key];
                    }
                    else if (element.tagName === 'OPTION') {
                        element.textContent = translations[lang][key];
                    }
                    else if (element.tagName !== 'BUTTON') {
                        element.innerHTML = translations[lang][key];
                    }
                }
            });
            currentLang = lang;
            localStorage.setItem('language', lang);
            if(langToggleButton) {
                const flag = lang === 'en' ? 'FR' : 'GB';
                langToggleButton.innerHTML = `<img src="https://flagsapi.com/${flag}/flat/24.png" alt="${flag} Flag">`;
            }
        }

        if(langToggleButton) {
            langToggleButton.addEventListener('click', () => {
                const newLang = currentLang === 'en' ? 'fr' : 'en';
                setLanguage(newLang);
            });
        }


        // Set max date for date pickers
        const todayForPicker = new Date();
        startDateInput.max = todayForPicker.toISOString().slice(0, 10);
        endDateInput.max = todayForPicker.toISOString().slice(0, 10);

        function toggleDatePickers() {
            if (filterTypeSelect.value === 'custom') {
                customDatePickers.style.display = 'block';
            } else {
                customDatePickers.style.display = 'none';
            }
        }

        async function applyFilter() {
            await loadChartData();
        }

        // Helper function to format date to DD-MMM-YY
        function formatDateDDMMMYY(dateString) {
            const date = new Date(dateString);
            const options = { day: '2-digit', month: 'short', year: '2-digit' };
            return date.toLocaleDateString('en-GB', options).replace(/ /g, '-').toUpperCase();
        }

        // renderChart function (globally accessible)
        function renderChart(type) {
            if (chart) {
                chart.destroy();
            }
            const ctx = document.getElementById('stepsChart').getContext('2d');
            if (!ctx) {
                return;
            }
            chart = new Chart(ctx, {
                type: type,
                data: chartData,
                options: {
                    scales: {
                        x: {
                            
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        async function loadChartData() {
            let stepsApiUrl = '/api/steps';
            let exercisesApiUrl = '/api/exercises';
            const filterType = filterTypeSelect.value;
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day

            let actualStartDate;
            let actualEndDate = today;

            if (filterType === '30days') {
                actualStartDate = new Date(today);
                actualStartDate.setDate(today.getDate() - 29); // Last 30 days including today
            } else if (filterType === 'custom') {
                const customStart = new Date(startDateInput.value);
                const customEnd = new Date(endDateInput.value);

                if (isNaN(customStart) || isNaN(customEnd) || customStart > customEnd) {
                    alert('Please select valid custom start and end dates.');
                    return;
                }
                actualStartDate = customStart;
                actualEndDate = customEnd;
            } else { // 'all'
                actualStartDate = new Date('2025-10-24'); // Fixed start date for all entries
            }
            
            // Format dates for API requests
            const formattedStartDate = actualStartDate.toISOString().slice(0, 10);
            const formattedEndDate = actualEndDate.toISOString().slice(0, 10);

            stepsApiUrl += `?startDate=${formattedStartDate}&endDate=${formattedEndDate}`;
            exercisesApiUrl += `?startDate=${formattedStartDate}&endDate=${formattedEndDate}`;


            const stepsResponse = await fetch(stepsApiUrl);
            const steps = await stepsResponse.json();
            const exercisesResponse = await fetch(exercisesApiUrl);
            const exercises = await exercisesResponse.json();

            const allDates = [];
            let currentDate = new Date(actualStartDate);
            while (currentDate <= actualEndDate) {
                allDates.push(currentDate.toISOString().slice(0, 10));
                currentDate.setDate(currentDate.getDate() + 1);
            }

            const stepsData = allDates.map(date => {
                const step = steps.find(s => s.date === date);
                return step ? step.quantity : 0;
            });

            const backgroundColors = allDates.map(date => {
                const exercise = exercises.find(ex => ex.date === date);
                if (exercise && exercise.done === 'Yes') {
                    return 'green';
                } else if (exercise && exercise.done === 'No') {
                    return 'orange'; // Amber
                }
                return 'grey'; // Default if no exercise entry
            });

            // Calculate Largest and Average Steps
            let largestSteps = 0;
            let largestStepsDate = 'N/A';
            let largestStepsIndex = -1; // To store the index of the largest steps
            const recordedStepsValues = [];

            for (let i = 0; i < allDates.length; i++) {
                const steps = stepsData[i];
                if (steps > 0) {
                    recordedStepsValues.push(steps);
                    if (steps > largestSteps) {
                        largestSteps = steps;
                        largestStepsDate = allDates[i];
                        largestStepsIndex = i; // Store the index
                    }
                }
            }
            
            const averageSteps = recordedStepsValues.length > 0 ? Math.round(recordedStepsValues.reduce((a, b) => a + b, 0) / recordedStepsValues.length) : 0;

            document.getElementById('largest-steps').textContent = largestSteps.toLocaleString();
            document.getElementById('largest-steps-date').textContent = `(${formatDateDDMMMYY(largestStepsDate)})`;
            document.getElementById('average-steps').textContent = averageSteps.toLocaleString();

            // Create borderColors array
            const borderColors = new Array(allDates.length).fill('rgb(75, 192, 192)'); // Default border color
            const borderWidths = new Array(allDates.length).fill(1); // Default border width

            if (largestStepsIndex !== -1) {
                borderColors[largestStepsIndex] = 'red';
                borderWidths[largestStepsIndex] = 1; // Make the border even thinner (1 pixel)
            }

            // Calculate running average
            const runningAverageData = [];
            let sum = 0;
            let count = 0;
            for (let i = 0; i < stepsData.length; i++) {
                if (stepsData[i] > 0) { // Only count days with steps for average
                    sum += stepsData[i];
                    count++;
                }
                runningAverageData.push(count > 0 ? Math.round(sum / count) : 0);
            }

            chartData = {
                labels: allDates, // Use raw dates for Chart.js internal logic
                datasets: [{
                    label: 'Steps per Day',
                    data: stepsData,
                    fill: false,
                    borderColor: borderColors, // Use the new borderColors array
                    borderWidth: borderWidths, // Use the new borderWidths array
                    backgroundColor: backgroundColors,
                    tension: 0.1
                },
                {
                    label: 'Running Average',
                    data: runningAverageData,
                    type: 'line', // This will always be a line
                    fill: false,
                    borderColor: 'blue',
                    borderWidth: 1, // Make the line thinner
                    tension: 0.1,
                    pointRadius: 0 // Hide points for a smoother line
                }]
            };

            renderChart('bar'); // Default to bar chart
            setLanguage(currentLang);
        }

        window.onload = () => {
            loadChartData();
            setLanguage(currentLang);
        };

        async function shareGraph() {
            const shareUrl = window.location.href;
            const shareTitle = "Fred's Steps Progress";
            const shareText = "Check out Fred's daily steps progress in his rehab journey!";

            if (navigator.share) {
                // Use Web Share API if available
                try {
                    await navigator.share({
                        title: shareTitle,
                        text: shareText,
                        url: shareUrl,
                    });
                    console.log('Web Share API used successfully!');
                } catch (error) {
                    console.error('Error sharing using Web Share API:', error);
                    fallbackShare(shareTitle, shareText, shareUrl);
                }
            } else {
                // Fallback for browsers that do not support Web Share API
                fallbackShare(shareTitle, shareText, shareUrl);
            }
        }

        function fallbackShare(title, text, url) {
            const emailSubject = encodeURIComponent(title);
            const emailBody = encodeURIComponent(`${text}\n\nView the graph here: ${url}`);
            const whatsappText = encodeURIComponent(`${text} ${url}`);

            const shareOptions = `
                Share this graph:
                \n\nEmail: mailto:?subject=${emailSubject}&body=${emailBody}
                \nWhatsApp: https://wa.me/?text=${whatsappText}
                \n\n(Copy the link to share on other platforms: ${url})
            `;
            alert(shareOptions);
        }
    </script>
</body>
</html>
</body>
</html>