<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fred's Rehab History</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1 data-translate="Fred's Rehab History">Fred's Rehab History</h1>
        <nav>
            <a href="/" data-translate="Enter Data">Enter Data</a>
            <a href="/enter-data-tabular.html" data-translate="Enter Data - Tabular">Enter Data - Tabular</a>
            <a href="/history.html" data-translate="View History">View History</a>
            <a href="/steps-graph.html" data-translate="View Steps Graph">View Steps Graph</a>
            <a href="/calendar-view.html" data-translate="Calendar View">Calendar View</a>
            <a href="/exercise-videos.html" data-translate="Exercise Videos">Exercise Videos</a>
            <a href="/help.html" data-translate="Help">Help</a>
            <button id="lang-toggle"><img src="https://flagsapi.com/FR/flat/24.png" alt="French Flag"></button>
        </nav>
    </header>
    <main>
        <table id="history-table">
            <thead>
                <tr>
                    <th data-translate="Date">Date</th>
                    <th data-translate="Exercises Done">Exercises Done</th>
                    <th data-translate="Repetitions">Repetitions</th>
                    <th data-translate="Steps">Steps</th>
                    <th data-translate="Comments">Comments</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <div style="display: flex; justify-content: space-between; margin-top: 1.5em; gap: 1em;">
            <button onclick="shareHistory()" data-translate="Share History">Share History</button>
            <button onclick="clearHistory()" style="background-color: #dc3545;" data-translate="Clear All History">Clear All History</button>
        </div>
    </main>

    <script src="translations.js"></script>
    <script>
        const langToggleButton = document.getElementById('lang-toggle');
        let currentLang = localStorage.getItem('language') || 'en';

        function setLanguage(lang) {
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'BUTTON' && element.id !== 'lang-toggle') {
                        element.textContent = translations[lang][key];
                    } else if (element.tagName !== 'BUTTON') {
                        element.innerHTML = translations[lang][key];
                    }
                }
            });
            currentLang = lang;
            localStorage.setItem('language', lang);
            if (langToggleButton) {
                const flag = lang === 'en' ? 'FR' : 'GB';
                langToggleButton.innerHTML = `<img src="https://flagsapi.com/${flag}/flat/24.png" alt="${flag} Flag">`;
            }
        }

        if (langToggleButton) {
            langToggleButton.addEventListener('click', () => {
                const newLang = currentLang === 'en' ? 'fr' : 'en';
                setLanguage(newLang);
            });
        }


        // Helper function to format date to DD-MMM-YY
        function formatDateDDMMMYY(dateString) {
            const date = new Date(dateString);
            const options = { day: '2-digit', month: 'short', year: '2-digit' };
            return date.toLocaleDateString('en-GB', options).replace(/ /g, '-').toUpperCase();
        }

        async function loadData() {
            let exercisesResponse;
            try {
                exercisesResponse = await fetch('/api/exercises');
                if (!exercisesResponse.ok) throw new Error(`HTTP error! status: ${exercisesResponse.status}`);
            }
            catch (e) {
                console.error("[ERROR History] Failed to fetch exercises:", e);
                return;
            }
            const exercises = await exercisesResponse.json();

            let stepsResponse;
            try {
                stepsResponse = await fetch('/api/steps');
                if (!stepsResponse.ok) throw new Error(`HTTP error! status: ${stepsResponse.status}`);
            }
            catch (e) {
                console.error("[ERROR History] Failed to fetch steps:", e);
                return;
            }
            const steps = await stepsResponse.json();

            const data = {};

            exercises.forEach(ex => {
                if (!data[ex.date]) {
                    data[ex.date] = {};
                }
                data[ex.date].exercise = ex;
            });

            steps.forEach(step => {
                if (!data[step.date]) {
                    data[step.date] = {};
                }
                data[step.date].steps = step;
            });

            const tableBody = document.querySelector('#history-table tbody');
            if (!tableBody) {
                console.error("Could not find #history-table tbody. Is the HTML structure correct?");
                return;
            }
            tableBody.innerHTML = '';

            const sortedDates = Object.keys(data).sort((a, b) => new Date(a) - new Date(b));

            if (sortedDates.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 5; // Span all columns
                cell.textContent = "No history data available.";
                cell.style.textAlign = "center";
                return;
            }

            let emailBody = "Fred's Rehab History:\n\n";
            emailBody += "Date\tExercises Done\tRepetitions\tSteps\tComments\n";
            emailBody += "--------------------------------------------------------------------------\n";

            for (const date of sortedDates) {
                const row = tableBody.insertRow();
                const dateCell = row.insertCell();
                const exerciseDoneCell = row.insertCell();
                const repetitionsCell = row.insertCell();
                const stepsCell = row.insertCell();
                const commentsCell = row.insertCell();

                const exercisesDone = data[date].exercise ? data[date].exercise.done : 'No';
                const repetitions = data[date].exercise ? data[date].exercise.quantity : 'N/A';
                const stepsCount = data[date].steps ? data[date].steps.quantity.toLocaleString() : 0;
                const comments = data[date].steps && data[date].steps.comments ? data[date].steps.comments : '';

                dateCell.textContent = formatDateDDMMMYY(date); // Format date for display
                exerciseDoneCell.textContent = exercisesDone;
                repetitionsCell.textContent = repetitions;
                stepsCell.textContent = stepsCount;
                commentsCell.textContent = comments;

                emailBody += `${formatDateDDMMMYY(date)}\t${exercisesDone}\t${repetitions}\t${stepsCount}\t${comments}\n`;
            }

            window.historyEmailBody = emailBody; // Store for access by shareHistory function
            setLanguage(currentLang);
        }

        async function clearHistory() {
            if (confirm("Are you sure you want to delete ALL history data? This action cannot be undone.")) {
                const response = await fetch('/api/history', {
                    method: 'DELETE'
                });
                if (response.ok) {
                    alert("All history data cleared successfully!");
                    loadData(); // Reload data to update the table
                } else {
                    alert("Failed to clear history data.");
                }
            }
        }

        async function shareHistory() {
            const shareUrl = window.location.href;
            const shareTitle = "Fred's Rehab History";
            const shareText = "Check out Fred's rehab progress history!";

            if (navigator.share) {
                // Use Web Share API if available
                try {
                    await navigator.share({
                        title: shareTitle,
                        text: shareText,
                        url: shareUrl,
                    });
                    console.log('Web Share API used successfully!');
                } catch (error) {
                    console.error('Error sharing using Web Share API:', error);
                    fallbackShare(shareTitle, shareText, shareUrl);
                }
            } else {
                // Fallback for browsers that do not support Web Share API
                fallbackShare(shareTitle, shareText, shareUrl);
            }
        }

        function fallbackShare(title, text, url) {
            const emailSubject = encodeURIComponent(title);
            const emailBody = encodeURIComponent(`${text}\n\nView the history here: ${url}\n\n${window.historyEmailBody}`); // Include table data
            const whatsappText = encodeURIComponent(`${text} ${url}`);

            const shareOptions = `
                Share this history:
                \n\nEmail: mailto:?subject=${emailSubject}&body=${emailBody}
                \nWhatsApp: https://wa.me/?text=${whatsappText}
                \n\n(Copy the link to share on other platforms: ${url})
            `;
            alert(shareOptions);
        }

        window.onload = () => {
            loadData();
            setLanguage(currentLang);
        };
    </script>
